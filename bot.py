import atexit
from telegram import MessageEntity
from telegram.ext import CommandHandler, ApplicationBuilder, MessageHandler, filters

from config import TOKEN
from database import conn, cursor, create_db, add_predictions_from_block
from admin import *
from chat import *
from commands import *
from interactions import *


def main():
    bot = ApplicationBuilder().token(TOKEN).build()

    commands = {
        "mute": mute,
        "unmute": unmute,
        "ban": ban,
        "unban": unban,
        "listwarn": listwarn,
        "warn": warn,
        "unwarn": unwarn,
        "resetwarn": resetwarn,
        "start": start,
        "rules": rules,
        "moodle": moodle,
        "links": links,
        "scores": scores,
        "plan": plan,
        "maptuke": maptuke,
        "map5p": map5p,
        "studijne": studijne,
        "schedule": schedule,
        "invite": invite,
        "week": week,
        "meme": meme,
        "predict": predict,
        "weather": weather,
        "chance": chance
    }

    for command, handler in commands.items():
        bot.add_handler(CommandHandler(command, handler))

    bot.add_handler(MessageHandler(filters.ChatType.PRIVATE & ~filters.COMMAND, start_message))
    bot.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, welcome))
    bot.add_handler(MessageHandler((filters.ChatType.GROUP | filters.ChatType.SUPERGROUP) & ~filters.COMMAND, reaction))

    print("Starting Telegram Bot...")
    bot.run_polling(drop_pending_updates=True)


def close_db():
    print("Closing database connection...")
    cursor.close()
    conn.close()



if __name__ == '__main__':
    create_db()

    text = """Ти зайдеш у Teams, і викладач уже 20 хвилин пиздить сам із собою. Webex зависне саме тоді, коли ти спиздив відповідь з чату. Твоє “dobrý deň” викладач почув як “dopiče”. Камера включилась — а ти голий як piča. Словацькі студенти думають, що ти genius, а ти просто ctrl+c, ctrl+v. Твій мікрофон у Teams зловив, як ти сказав “kokot system”. Твоє кохання зі словачкою закінчиться на слові “kurva”. Викладач завис у Webex, як твої надії на майбутнє. Ти думаєш, що тебе не видно, але вся група бачила, як ти хуярив борщ. Твої знання зросли рівно на стільки, скільки пляшок пива ти випив. Словацький студент назвав тебе piča, але все одно списав у тебе. Ти відкрив камеру, а позаду валяється пляшка borovičky. Викладач у Teams сказав “máte otázky?”, а ти відповів “jebať”. Твої відносини з одногрупницею-словачкою тримаються тільки на пиві. Твоє серце на Erasmus розбили два kokoti й одна piča. Ти думав, що MS Teams — пекло, а потім зайшов у Webex. Словацький студент питає “čo robíš?”, а ти кажеш “vyjebávam sa”. Твій інтернет зник, як твоє натхнення на курсову. Ти напишеш екзамен, але не відправиш, бо Teams crashнув. Твоє кохання з україночкою закінчиться після “choď do riti”. Викладач почув, як ти сказав “kurva mater”, і зробив вигляд, що нічо. Ти будеш сидіти на Webex, але реально дрочити меми. Словацькі студенти кличуть пити, а ти вже в гімні з учора. Твоє “дякую” на іспиті прозвучало як “pičovina”. Ти думав, що словачка з тобою через любов, а вона за občianstvo. Твої знання такі ж хуєві, як переклад Teams. Твоє майбутнє з українкою і словаком — сварки на трьох мовах. Викладач каже “skúška ľahká”, а ти вже плачеш dopiče. Ти списуєш у чатику, але викладач теж там сидить. Словацький студент назвав тебе братушкою, і ви пішли бухати. Твій Webex вирубився на слові “odpoveď”. Ти думаєш, що словачки тебе люблять, але їм треба житло. Твоє життя між Teams і кухнею — endless kokotina. Ти закохався в словачку, але вона пішла до чеха. Твій мікрофон знову ловить, як ти кричиш “kurva wifi”. Ти відкриєш Webex і побачиш там лише pičoviny. Словацькі студенти сміються з твоїх матюків, але самі кажуть “kokot”. Твоє кохання в Teams заглохло через mute. Ти напишеш викладачу в чат, а він відповість “choď do piče”. Твоя камера показала, як ти жер лапшу з каструлі. Словацький студент кине тобі “čau bratu”, а потім злиже твою дівчину. Твоє життя на онлайн-навчанні — чиста vysratá piča. Викладач у Webex виглядає як huj у хмарі. Твоє серце розбите так само, як твій ноутбук після екзамену. Словаки кличуть на borovičku, а ти вже v riťi. Ти включив Teams, а мікрофон ловить твої матюки до сусіда. Твої відносини з одногрупницею тримаються на пиві й депресії. Ти написав “ďakujem” у чат, а вийшло “dopiče”. Твій викладач думає, що ти piča, і він має рацію. Словацький студент буде з тобою пити, а потім списувати. Твої спроби знайти любов в уніку закінчаться на Tinder. Викладач спитає тебе в Webex, а ти завис, як kokot. Твоє майбутнє з українкою в Словаччині — борщ і pivo. Ти думав, що словачки тебе люблять, а їм просто smutno. Твоє кохання закінчиться на фразі “choď spať, kokot”. Ти в Teams казав “так, так”, а реально хавав піцу. Словацькі студенти думають, що ти мудрий, але ти просто piča. Твій викладач скаже “vy to zvládnete”, і ти засмієшся, kurva. Ти закохався в словачку, а вона кохає твою стипендію. Твої знання зростуть рівно настільки, як твій алкоголізм. Викладач у Webex спитає, а ти відповіси “huj vie”. Твоє кохання заглохне швидше, ніж Teams call. Словацький студент покаже тобі, як правильно vysrať sa з іспиту. Ти відкриєш камеру і побачиш свою pičovinu на екрані. Твої сусіди почують твоє “kurva wifi” ще тричі сьогодні. Твої відносини зі словачкою закінчаться на слові “nechaj ma”. Ти думав, що Erasmus — рай, а це hujovina. Викладач почув, як ти сказав “vyjebať sa з Teams”. Твої мрії розбилися об Webex error 403. Ти закохався в словачку, але вона piča. Твої знання такі ж пусті, як чат у Teams після пари. Твій мікрофон ловить тільки “kokot” і “kurva”. Словацький студент назвав тебе brat, а завтра здав тебе. Ти зайшов у Webex і зрозумів, що ти huj. Твоє майбутнє — endless kurva skúšky. Ти казав “я знаю відповідь”, а вийшло “piča system”. Твої відносини з українкою закінчаться після першої borovičky. Словаки сміються з твого акценту, але списують у тебе. Ти на Teams включив screen share і показав порно. Твій викладач каже “nebojte sa”, а ти вже плачеш. Твої знання такі ж короткі, як семестр онлайн. Словацький студент каже “choďme na pivo”, і все, ти пропав. Ти відкрив Webex, а там викладач знову vysratý. Твоє майбутнє після диплому — курва život. Ти думаєш, що словачки тебе люблять, але їм smutno. Твої матюки в Teams стали легендою групи. Ти казав “ďakujem”, а почув “kokot”. Словацькі студенти думають, що ти курва rebel, але ти huj. Твій викладач у Teams виглядає, як vysratá piča. Ти написав курсову, але Webex її не прийняв. Твої відносини зі словачкою згоріли швидше, ніж твій ноутбук. Ти думаєш, що online easy, але це endless kokotina. Словацький студент скаже “čau”, а ти “dopiče”. Твоє майбутнє знову зламав Teams error. Ти закохався в українку, яка виїхала до Prahy. Твої оцінки нижчі, ніж твій IQ після borovičky. Викладач у Webex почує тільки твоє “kurva wifi”. Твоє кохання знову закінчилось на слові “piča”. Ти в Teams написав “я готовий”, але це hujovina. Словацький студент сказав “dobrý večer”, а ти “choď do riti”. Твоє життя між Teams і Webex — чиста jebačka. Ти знову проєбав дедлайн, але зато відкрив нове пиво. Викладач тебе зненавидів ще до того, як ти відкрив рот. Твій диплом такий же реальний, як твоє кохання. Ти будеш жити на енергетику і каві, поки не здохнеш. Залік приймуть, але твій мозок не пробачить. Сьогодні ти прокинувся, щоб зрозуміти: нахєра? Стипендія знову пішла на бухло, гордись. Викладач запитає, а ти обісрешся навіть від свого імені. Ти думаєш, що готовий до екзамену, але хуй там. Завтра будеш їсти макарони з кетчупом. Успіх тобі світить тільки в “Казино”. Хтось з твоєї групи вже спить із викладачем, і то не ти. Ти відкриєш конспект і зрозумієш, що писав хуй зна-що. Ти не дурень, ти просто вчишся в Словаччині. Твоє майбутнє таке ж розмите, як після шести шотів. На колоквіумі ти будеш як огірок — тупо лежати. Твої знання — як презерватив після пива: нуль захисту. В бібліотеці знайдеш любов, але то буде шаурма. Ти ще живий тільки завдяки маминим переказам. Замість диплома вийде дипломчик з “Мекдональдса”. Викладач поставить 4, щоб ти не здох від двійки. Ти поїдеш на “Еразмус” і там теж будеш лохом. Університет — це не знання, це виживання. В голові порожньо, зате в холодильнику теж. Коли здаватимеш сесію, то згадаєш усі молитви і матюки. Твої курсові читають тільки боти в Moodle. Сон — твій найбільший ворог і єдина любов. Викладач подивиться на тебе й подумає: “єбать, даремно живе”. Ти знову пропустиш пару, але ніхто й не помітить. Твої оцінки нижчі, ніж твій баланс на картці. Ти проснешся на лекції від власного хропіння. Твої конспекти виглядають як шкільні каракулі п’яного. Ти відкриєш книжку і вмреш від шоку. Викладач на іспиті спитає саме те, що ти не вчив. Ти будеш гуглити відповідь і все одно написати хуйню. В їдальні знову дадуть баланду під виглядом “гуляшу”. Твоє резюме ніхто не прочитає, бо ти ще студент. Твої друзі тебе здадуть за додаткові бали. Ти отримаєш три, але відсвяткуєш як нобелівку. Викладач поставить залік, бо йому впадло слухати тебе. Ти відкриєш Moodle і захочеш вскритися. Ти будеш жити на інстант-локшині й каві без цукру. Твоє старання оцінять лайком у Telegram-чаті. Ти на Erasmus знайдеш друзів, які теж ні хуя не вчаться. Твої знання зростуть настільки ж, як ціни в Братиславі. Ти знову підеш на пари вчорашній. Викладач дасть завдання, яке не вирішив би навіть Бог. Ти здав роботу — і сам не розумієш як. У тебе диплом, але роботи нема. Твоє майбутнє схоже на старий гуртожиток — пиздець. Ти забудеш здати роботу в Moodle і знову будеш плакати. Ти напишеш курсову з чат-ботом і будеш гордитись. Твоє життя — нескінченний дедлайн. Ти підеш на лекцію, а там викладача нема. Викладач подивиться в очі й скаже: “пизда тобі”. Ти напишеш шпаргалку, але забудеш її вдома. Твої оцінки такі ж, як якість інтернету в гуртожитку. Ти отримаєш кредит, але не залік. У тебе 0 євро, але зато 100 проблем. Викладач знову змінить тему курсової, і ти поїдеш кукухою. Ти будеш жити в бібліотеці й помреш там же. Слово “залік” викликає в тебе PTSD. Ти будеш святкувати 4 як весілля. Твій диплом нікому не потрібен, навіть тобі. Твої викладачі п’ють більше за тебе. Ти захочеш здати роботу, але Moodle ляже. Ти напишеш код, який зламає сервер. Викладач скаже “дуже цікаво”, і ти відчуєш, що спалився. Ти закохаєшся в одногрупницю, яка звалить до Чехії. Твої знання з інформатики — це Ctrl+C Ctrl+V. Ти будеш дивитись лекцію і нічого не розуміти. Твій настрій тримається на каві й цигарках. Ти отримаєш двійку й скажеш: “це теж результат”. Твої сусіди по гуртожитку знову влаштують дискотеку. Ти підеш на лекцію і заснеш через 5 хвилин. Твої одногрупники зроблять проєкт без тебе. Ти здаси екзамен лише тому, що викладач був п’яний. Твої конспекти згорять разом з ноутбуком. Ти підеш в їдальню і знову з’їси “суп з хуйні”. Твоє життя — серіал без сценарію. Твої гроші закінчились, а місяць ще ні. Ти знову забудеш здати завдання й будеш плакати. Твоя єдина оцінка “А” — це “А хулі я сюди прийшов”. Ти проснешся і зрозумієш, що екзамен був учора. Викладач знову скаже: “це не відповідає темі”. Ти отримаєш кредитку, щоб закрити борги по кредитах. Ти запізнишся на пару і зрозумієш, що її відмінили. Твої думки на екзамені — суцільні матюки. Ти спиш більше на лекціях, ніж у ліжку. Твої мрії про Erasmus закінчаться на заповненні анкети. Твої знання такі ж корисні, як дірявий презерватив. Ти знову купиш найдешевше пиво й будеш щасливий. Твоє майбутнє в Словаччині — це Uber і кол-центр. Ти вивчиш словацьку тільки для того, щоб матюкатися. Твої конспекти підуть на розпалку шашликів. Ти здаси курсову, але викладач знайде 200 помилок. Твої одногрупники підуть у ІТ, а ти залишишся з боргами. Ти напишеш диплом, але забуде його захистити. Твоє життя після уніку — така ж хуйня, як під час. Ти будеш їсти ролтон і називати це вечерею. Ти зрозумієш, що твоя освіта нахуй нікому не потрібна. Твої плани на майбутнє — бухло і депресія. Викладач подивиться на твою роботу і скаже: “єбать, що це?”. Ти ще не випустився, а вже вигорів. Твоя бакаларська робота буде така сама хуїта, як твій конспект з матану. Ти напишеш 60 сторінок диплома, а викладач скаже: «шо це за піздєц, бля?» Ти — невдаха року, і навіть Moodle це підтвердить. Твою бакаларську роботу викладач використає як туалетний папір. Ти думаєш, що захист пройде нормально, але це буде повний їбучий цирк. Викладач подивиться на твій диплом і скаже: «піздєц, ти ж нічого не знаєш». Твоє життя після бакалаврату — кур’єр у Wolt, блядь. Твій диплом нікому нахуй не потрібен, навіть твоїй мамі. Ти такий же геній, як хуйлостанський політик. Твоя бакаларка буде виглядати як ctrl+c, ctrl+v із Вікіпедії. Ти захистиш роботу, але ніхуя не згадаєш, про шо там писав. Ти думаєш, що ти айтішник, а ти просто пиздюк із лаптопом. Твій науковий керівник назве тебе конченим і не схибить. Ти спиш більше на парах, ніж дома, і все одно виглядаєш як хуй. Твоя бакаларська робота вартує рівно стільки ж, як рулон сраної бумаги. Ти будеш вчитись 5 років, щоб заробляти мінімалку. Твоя майбутня робота після диплому — касир у Lidli, нахуй. Ти думав, що будеш програмістом, але ти тупо долбоєб. Твої знання зростуть рівно настільки, наскільки ти вмієш пиздіти. Твою роботу викладач навіть не читатиме, бо ти ніхуя не писав. Ти відкриєш диплом і сам охуєєш від тої хуйні. Ти будеш невдахою навіть серед невдах, бля. Твоїм науковим керівником буде кончений алкоголік. Твоє майбутнє після бакалаврату — пизда і борг по кредитці. Ти напишеш диплом, а захистять його твої матюки. Твої друзі вже в Чехії на заводі, а ти ще з бакаларкою їбешся. Твій науковий керівник скаже: «бля, ти шо повний ідіот?». Твої знання такі ж мертві, як твій мозок після сесії. Твою роботу назвуть «повна хуйня з прикрутами». Ти будеш захищати диплом і проїбешся на власному імені. Твої викладачі пам’ятають тебе як конченого лінтяя. Ти — пиздєц як невдаха, але ще й смішний. Твоя бакаларська презентація виглядатиме як слайдшоу з сраки. Ти будеш захищатись і думати тільки про пиво. Твоя наукова робота піде нахуй одразу після захисту. Твоє майбутнє світить тільки в якості бухого тестувальника. Твій диплом такий же цінний, як порожня пляшка від боржомі. Ти будеш сидіти на захисті і виглядати як їбаний дебіл. Твій науковий керівник скаже «похуй, здавай так». Твоє життя — це суцільний дедлайн і пизда. Ти ще не почав писати бакаларку, а вже пішов на пиво. Твої аргументи такі ж пусті, як твій холодильник. Твої знайомі вже працюють, а ти ще їбешся з Word. Твою роботу зламає Word на 59 сторінці. Ти будеш невдахою навіть після диплому, пиздець. Твоє серце і диплом горять одночасно. Ти думав, що встигнеш, а вийшло «пізда рулям». Твої викладачі на захисті будуть просто з тебе ржати. Ти напишеш висновки на «і так все понятно». Твоє майбутнє виглядає як смітник після дискотеки. Ти не здав диплом, але здав печінку пиву. Твої знання такі ж міцні, як твої очі після 2 літрів пива. Твою бакаларку ніхто не прочитає, навіть ти. Ти думаєш, що ти герой, а ти їбаний статист. Твоє життя — endless срач між Moodle і Word. Ти будеш захищати диплом і казати «я хуй зна шо робив». Твоя робота — це просто збірник хуйні. Ти ще студент, але вже зламаний морально і фізично. Твої оцінки — сміх і гріх. Твій викладач назве тебе конченим і дасть трійку з жалю. Ти написав роботу, але забув вставити сторінку з цілями. Твої знайомі вже айтішники, а ти невдаха. Твоя бакаларка виглядає як реферат з інфи за 9 клас. Ти будеш стояти на захисті і тупо кліпати очима. Твої аргументи будуть такі ж тупі, як твій почерк. Твоє майбутнє — повний піздєц, але зі сміхом. Ти думаєш, що все добре, але це хуйня. Ти отримаєш диплом і підеш на біржу. Твої знання закінчаться на слові «ебать». Твою бакаларку спалять як непотріб. Ти на захисті будеш стояти як huj. Твій диплом не потрібен навіть твоїй кицьці. Ти будеш невдахою навіть серед айтішників. Твоє життя — endless матюки і срач. Твої викладачі давно списали на тобі хрест. Ти закінчив універ і зрозумів, що це все була їбана фігня. Твої знання = пиздєц. Твоє майбутнє після диплому — пиво і депресія. Ти думаєш, що ти інженер, а ти кончений. Твою роботу викладач назве «гівно в обгортці». Твої відносини з дипломом коротші, ніж твій сон. Ти думав, що все встигнеш, але пішов бухати. Твоя бакаларка — повна срака. Твої викладачі думають, що ти мудак. Ти написав висновки на «похуй». Твоє майбутнє після диплому — мінімалка і пиво. Ти будеш жити з дипломом і боргами. Твоя бакаларка смішніша, ніж будь-який стендап. Ти — легенда невдах. Твоя наукова робота = повний піздєц. Ти будеш стояти на захисті і думати «нахуя». Твої викладачі поставлять 3 і пошлють тебе нахуй. Твоє життя після диплому — endless хуїта. """
    BLOCK = "\n".join(s.strip() for s in text.split(". ") if s.strip())

    inserted = add_predictions_from_block(BLOCK, locale="uk")
    print(f"Спробував вставити рядків: {inserted}")

    main()

    atexit.register(close_db)
