import atexit
from telegram import MessageEntity
from telegram.ext import CommandHandler, ApplicationBuilder, MessageHandler, filters

from config import TOKEN
from database import conn, cursor, create_db, add_predictions_from_block
from admin import *
from chat import *
from commands import *
from interactions import *


def main():
    bot = ApplicationBuilder().token(TOKEN).build()

    commands = {
        "mute": mute,
        "unmute": unmute,
        "ban": ban,
        "unban": unban,
        "listwarn": listwarn,
        "warn": warn,
        "unwarn": unwarn,
        "resetwarn": resetwarn,
        "start": start,
        "rules": rules,
        "moodle": moodle,
        "links": links,
        "scores": scores,
        "plan": plan,
        "maptuke": maptuke,
        "map5p": map5p,
        "studijne": studijne,
        "schedule": schedule,
        "invite": invite,
        "week": week,
        "meme": meme,
        "predict": predict,
        "weather": weather,
        "chance": chance
    }

    for command, handler in commands.items():
        bot.add_handler(CommandHandler(command, handler))

    bot.add_handler(MessageHandler(filters.ChatType.PRIVATE & ~filters.COMMAND, start_message))
    bot.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, welcome))
    bot.add_handler(MessageHandler((filters.ChatType.GROUP | filters.ChatType.SUPERGROUP) & ~filters.COMMAND, reaction))

    print("Starting Telegram Bot...")
    bot.run_polling(drop_pending_updates=True)


def close_db():
    print("Closing database connection...")
    cursor.close()
    conn.close()



if __name__ == '__main__':
    create_db()

    text = """Ти зайдеш у Lidl, а там знову тільки курва акції на хуйню. Твоє майбутнє в Kauflande — стояти на касі, бо айтішником ти не став. Ти поселився на Jedlíkovej і зрозумів, що рай — це не тут, а пизда. Твій гуртожиток на Boženke знову смердить борщем і потом. Ти відкрив холодильник у гуртожитку, а там тільки курва пиво. Твої знання такі ж пусті, як полиці в Lidl після 19:00. Ти думав, що на Jedlíkovej буде тихо, а там сусіди їбашать techno. Твій диплом не потрібен навіть охоронцю в Kauflande. Ти встав у чергу в Lidl і вмер, бо там 40 людей перед тобою. Твої оцінки нижчі, ніж ціни на borovičku в Boženke. Ти відкрив вікно в гуртожитку, а в кімнату зайшов запах курви. Твої знання зростуть рівно настільки, як ціни в Kauflande. Твоє життя в Кошице — endless jebačka між парами і бухлом. Ти закохався в словачку з Jedlíkovej, але вона piča. Твої гроші зникли швидше, ніж акції в Lidl. Викладач думає, що ти kokot, і має рацію. Твоє майбутнє після Boženky — Uber Eats на скутері. Ти йдеш у Kaufland за хлібом, а виходиш з пивом. Твої конспекти такі ж роздьобані, як гуртожиток на Jedlíkovej. Ти думаєш, що живеш у гуртожитку, а реально у свинарнику. Твоє серце в Кошице розбилося об бетон Jedlíkovej. Ти знову не встав на пару, бо бухав у Boženke. Твої мрії про Erasmus зникли, як ковбаса на акції в Lidl. Ти відкрив Kaufland о 21:55 і зрозумів, що ти kokot. Твоє життя — endless cesta з Boženky до TUKE. Ти думав, що навчання важке, а потім прийшла сесія — пизда. Твій диплом такий же цінний, як чек з Lidla. Ти підеш у Kaufland за молоком, а повернешся бухим. Твоє майбутнє в Кошице — жити з маминих переказів. Ти думав, що з Jedlíkovej видно місто, а видно тільки пизду. Твій гуртожиток знову відключив воду, бо kokotina. Ти спиш у Boženke, а сусід їбе шаурму о третій ночі. Твої оцінки такі ж порожні, як холодильник у гуртожитку. Твоє життя між Lidl і TUKE — endless hujovina. Ти хотів стати айтішником, а став курва касиром у Kauflande. Твої знання про математику — нуль, але пива ти знаєш всі марки. Ти закохався на Boženke, але її вже від’їбав чех. Твої курсові роботи виглядають як чек з Lidl. Твоє серце б’ється тільки від енергетика за 0.39€. Ти купив найдешевше пиво і гордий, як kokot. Твої друзі на Jedlíkovej такі ж бідні, як і ти. Ти йшов у бібліотеку, а зайшов у бар. Твоє життя в Boženke — nonstop disco з пивом. Ти хотів написати бакаларку, але написав хуй. Твоє майбутнє в Кошице — endless depresia. Твої гроші пішли на Lidl, а ти жреш лапшу. Ти думав, що буде Erasmus, але буде kurva nič. Твої оцінки нижчі, ніж під’їзд на Boženke. Ти написав конспект, але зрозумів, що то hujovina. Твоє життя — nonstop від Kauflandu до Boženky. Ти встав у чергу на Jedlíkovej, щоб помитися. Твої мрії зникли разом з акціями в Lidl. Ти думав, що викладач допоможе, а він сказав: choď do piče. Твій гуртожиток знову смердить сракою. Твоє майбутнє — бухати borovičku в Boženke. Ти хотів написати код, але відкрив пиво. Твої сусіди такі ж долбоєби, як ти. Ти вийшов з TUKE і зайшов у kurva život. Твої знання такі ж короткі, як акції в Kauflande. Ти закохався в дівчину з Lidl, але вона касирка. Твоя бакаларка виглядає як список покупок. Ти думав, що на Boženke весело, а там пизда. Твої гроші закінчились на другому тижні місяця. Твоє життя — endless hujovina між Jedlíkovej і TUKE. Ти купив найдешевший хліб і плачеш. Твої знання нікому не потрібні, навіть тобі. Ти йшов на пару, але зайшов у Lidl. Твої одногрупники думають, що ти piča, і не помиляються. Твоє майбутнє в Boženke — бути курва мемом. Ти думав, що навчання легке, а потім прийшла kurva skúška. Твої викладачі думають, що ти huj. Твоє серце б’ється тільки на акції в Lidl. Ти думав, що Boženka — рай, а це пекло. Твої знання про життя = пизда. Ти купив енергетик за 0.29 і думаєш, що живеш. Твоє життя в Кошице — endless depresia і kokotina. Ти думав, що знайдеш любов у Lidl, а знайшов пиво. Твої одногрупники вже в Чехії, а ти на Jedlíkovej. Ти написав курсову, але ніхуя не зрозумів. Твоє майбутнє в Кошице — робота на касі. Ти хотів їсти, а купив пиво. Твої друзі такі ж piče, як і ти. Ти думав, що Boženka краща за Jedlíkovej, а вийшло huj. Твоє серце зламалось від їдальні TUKE. Ти написав диплом, але викладач сказав: p*zdovina. Твоє життя між Lidl і Boženke — endless pičovina. Ти думав, що на Jedlíkovej буде комфортно, а там kurva nič. Твої гроші пішли на пиво, а ти їси лапшу. Твої знання нижчі, ніж полиці в Kauflande. Ти написав шпаргалку, але забув її вдома. Твоє життя в Boženke — nonstop smrad. Ти думав, що викладач нормальний, а він piča. Твої друзі думають, що ти genius, а ти kokot. Твоє серце належить borovičke. Ти хотів йти на роботу, але залишився бухати. Твої оцінки нижчі, ніж акції в Lidl. Ти закохався на Jedlíkovej, а вона вже з іншими. Твоє життя — endless kurva vtip. Ти написав резюме, але навіть Lidl тебе не взяв. Ти зайшов у “Ліцей КМ”, а там 1000 повідомлень про хуйню. Твоє питання “яка пара завтра?” загубилось серед “йобаний треш”. Ти спитав про лінк на Teams, а отримав “пошел нахуй”. Твої конспекти скинули в “Ліцей КМ”, але там тільки картинки хуїв. Ти написав “дякую”, а 50 людей поставили смайлик 💩. Твоє повідомлення в “Ліцей КМ” ніхто не читає, бо там постійний срач. Ти зайшов на 5 хвилин, а вийшов уже без кукухи. Твої питання завжди ігнорять, бо ти, блять, невидимка. Ти думаєш, що “Ліцей КМ” допоможе, а це просто пиздець-флудилка. Ти знову проєбав дедлайн, бо “Ліцей КМ” заспамили мемами. Ти шукав конспект, а знайшов 300 хуїв у стікерах. Твої одногрупники дрочать меми, замість дати відповідь. Ти написав викладачу в “Ліцей КМ”, а він вийшов нахуй. Ти питав про літературу, а отримав “піздуй у Google”. Твої нерви згоріли швидше, ніж “Ліцей КМ” після слова “сесія”. Ти думав, що “Ліцей КМ” — підтримка, а це суцільний пиздець. Твої повідомлення читають тільки боти. Ти написав “є лінк на Moodle?”, а отримав “йди нахуй”. Твоя надія знайти відповідь у “Ліцей КМ” така ж мертва, як твій диплом. Ти спитав “який викладач?”, а в “Ліцей КМ” почали їбати політику. Ти думав, що студенти онлайн дружні, а вони всі пиздуни. Твої одногрупники такі ж ліниві, як ти, тільки з більшим ротом. Ти заходиш у “Ліцей КМ” після 5 годин — і там 2000 повідомлень про хуй зна-що. Ти намагався знайти конспект, але там тільки “ахахах” і “єбать”. Твій “Ліцей КМ” перетворився на срач про борщ і пизду. Ти написав “хто буде на екзамені?”, а тобі скинули порнуху. Твоє життя в “Ліцей КМ” — endless пиздець. Ти хотів підготуватись, а отримав PTSD від “Ліцей КМ”. Твої повідомлення завжди губляться між “нахуй, курва” і “лол”. Ти написав “привіт”, а “Ліцей КМ” вибухнув на 500 повідомлень хуйньою. Твої спроби бути серйозним у “Ліцей КМ” закінчуються матами. Ти хотів організувати групу, але всі пішли нахуй. Твоя стипендія згоріла, як нерви у “Ліцей КМ”. Ти написав “коли дедлайн?”, а отримав 50 варіантів “хуєво”. Твоє питання нікому не цікаве, бо там новий мем про курву. Ти знову завис у “Ліцей КМ” замість робити курсову. Ти хотів вийти з “Ліцей КМ”, але тоді ти взагалі пиздець. Твої повідомлення в “Ліцей КМ” ігнорять так само, як твої оцінки. Ти шукаєш допомогу, а знаходиш тільки пизду. Ти питав “де екзамен?”, а хтось скинув “йобана сосиска”. Твоя надія на “Ліцей КМ” — найбільший хуй. Ти думав, що там студенти, а там пиздуни і долбоєби. Ти спитав “де викладач?”, а “Ліцей КМ” почав обсирати Boženku. Ти намагався серйозно вчитись, але “Ліцей КМ” — це курва цирк. Твої повідомлення бачать, але відповідають хуй зна-що. Ти написав “є pdf?”, а отримав “йди нахуй, студент”. Твої нерви згоріли, як роутер у Boženke. Ти хотів зібрати групу, але вони зібрали срач. Твоє питання викликало більше матюків, ніж відповідей. Ти думав, що “Ліцей КМ” — поміч, а це суцільний пиздець. Ти написав викладачу, але “Ліцей КМ” тебе з’їв. Твої друзі в “Ліцей КМ” такі ж мудаки, як ти сам. Ти хотів підтримки, але отримав “нахуй іди”. Твоє життя онлайн — endless срач у “Ліцей КМ”. Ти хотів знайти любов у “Ліцей КМ”, а знайшов пизду. Ти написав “дякую”, а отримав 30 “їбало закрий”. Ти думав, що “Ліцей КМ” врятує, а він тебе добив. Ти шукав pdf, а знайшов срач про ціну пива. Твої питання губляться в горах хуйні. Ти написав “є лінк?”, а отримав “йди в сраку”. Твоє серце розбили повідомленням “kurva nič nevieš”. Ти думав, що онлайн легше, але “Ліцей КМ” тебе доїбав. Твої повідомлення такі ж нікчемні, як твоя бакаларка. Ти написав “я не розумію завдання”, а “Ліцей КМ” відповів “ахах ти долбоєб”. Твоє життя в “Ліцей КМ” — nonstop срач і мат. Ти хотів підготуватись, але “Ліцей КМ” гірший за пиздець. Ти думав, що це група студентів, а це збіговисько курв. Ти написав “є конспект?”, а “Ліцей КМ” вибухнув хуями. Твої повідомлення тонуть у потоках єблі. Ти написав викладачу, а йому похуй. Твої друзі в “Ліцей КМ” сміються, поки ти гориш. Ти хотів організації, а отримав “йобаний хаос”. Твоє життя — endless flood і срач. Ти написав “будь ласка”, а отримав “курва”. Ти думав, що “Ліцей КМ” допоможе, а він тільки доїбав. Твої повідомлення такі ж корисні, як твій диплом. Ти написав “привіт”, а “Ліцей КМ” на 100 людей обісрав тебе. Твої конспекти в “Ліцей КМ” ніхто не читає, бо там тільки пизда. Ти думав, що “Ліцей КМ” — для навчання, а це пиздець клуб по інтересах. Ти написав “є завдання?”, а отримав “йди нахуй, курва”. Твоє життя — endless єбля нервів через “Ліцей КМ”. Ти хотів бути активним, а став клоуном “Ліцей КМ”. Твої повідомлення ігнорять навіть твої друзі. Ти думав, що “Ліцей КМ” — твоя надія, а це пизда. Ти написав “дякую”, а всі відповіли хуями. Твоє серце вмерло від “Ліцей КМ”. Ти думав, що група врятує, а вона тебе закопала. Ти написав “є тест?”, а отримав “нахуй іди з “Ліцей КМ””. Твої повідомлення = нуль, “Ліцей КМ” = пиздець. Ти написав серйозно, а “Ліцей КМ” відправив тебе нахуй. Твоє життя онлайн — nonstop пиздець і меми. Ти думав, що онлайн легше, а воно — пізда. Твої повідомлення пропали, як твоя стипендія. Ти написав “дякую”, а отримав “курва”. Твоє серце не витримало “Ліцей КМ”. Ти думав, що студенти підтримають, а вони послали нахуй. Твої повідомлення = сміття, “Ліцей КМ” = хуїта. Ти написав “є конспект?”, а “Ліцей КМ” тобі в ебало кинув мем. Адміни скажуть “зараз вирішимо”, а самі підуть пиздячити каву. Ти написав адмінам про проблему, а вони відповіли “похуй, розберемось завтра”. Адміни думають, що вони боги, а реально ліниві хуї. Ти просиш адмінів щось зробити, а вони знову в єбучому Lidl. Адмін каже “ми працюємо”, а сам їбе борщ на Jedlíkovej. Твою проблему в чаті адміни ігнорять, бо їм похуй. Адміни завжди busy, але реально дивляться серіальчики. Ти написав адмінам SOS, а вони відповіли “курва, потім”. Адмін обіцяв бан, але пішов бухати на Boženku. Твої звернення до адмінів так само марні, як Moodle. Адміни в “Ліцей КМ” — найбільші ліниві підараси. Ти думаєш, що адміни тримають порядок, а вони дрочать меми. Адмін пообіцяв вирішити, але забув, бо набухався. Адміни створили правила, щоб їх не читати. Твою заявку на розбан адміни скинули в корзину. Адміни сидять у Kaufland і ржуть з твоїх проблем. Ти написав “мене заспамили”, а адмін сказав “йди нахуй”. Адміни роблять вигляд, що працюють, а реально курять. Твої проблеми для адмінів — це pičovina. Адміни більше часу проводять у барі, ніж у чаті. Ти думаєш, що адмін щось вирішить, а він проїбався. Адміни завжди кажуть “зараз бан”, а банять через тиждень. Ти попросив адмінів порядок, а вони ще більший срач розвели. Адміни = ліниві хуї з амбіціями. Твої репорти адміни читають на сраці. Адмін завжди знайде відмазку, щоб нічого не робити. Адміни люблять говорити “ми busy”, але busy їбашити пиво. Ти чекаєш на рішення, а адміни вночі грають у CS. Адміни не бани, а легендарні ліниві курви. Ти думаєш, що адміни мають владу, а вони мають лишній жир. Твоє питання загубилось у лінощах адмінів. Адмін обіцяв почистити чат, але чат уже в пизді. Адміни — це ті самі студенти, тільки з короною на хуї. Ти написав “тут спам”, а адмін сказав “та похуй, хай буде”. Адмін забанив того, кого любив, а тебе проігнорив. Адміни більше говорять “йобаний пиздець”, ніж щось роблять. Твої проблеми для адміна = “kurva nezaujíma ma”. Адміни люблять владу, але не люблять працювати. Адміни в чаті — головні пиздуни і нічого більше. Ти думаєш, що адмін строгий, а він лінивий хуй. Адміни сидять на Boženke і забули, що вони адміни. Твої надії на адмінів — повний пиздець. Адмін обіцяв бан, але банив свою печінку. Адміни ніколи не читають, але завжди “в курсі”. Ти думав, що адміни — рятівники, а це ліниві курви. Адміни знають тільки два слова: “похуй” і “потім”. Ти просив про допомогу, а адмін скинув мем з хуєм. Адміни — це як сесія: обіцяють жах, а виходить пиздець. и вийдеш з вокзалу в Кошице, і цигани вже кричать “pivo alebo cigarety?”. Твоє майбутнє схоже на вокзал Кошице — суцільний пиздець. Ти думаєш, що йдеш на пару, а виходиш на Лунік IX. Твої нерви горять швидше, ніж сміття на Луніку. Ти чекав на автобус, а цигани вже продали тобі старий айфон. Твоє життя як вокзал Кошице — там завжди хтось кричить “kurvaaa”. Ти думаєш, що студент, а виглядаєш як бездомний з вокзалу. Твої мрії загубились між циганами і розкладом поїздів. Ти зайшов у Lidl, а там пів Луніка IX. Твоє майбутнє таке ж хуєве, як туалет на вокзалі Кошице. Ти думаєш, що вчишся, а реально тулишся з циганами на Boženke. Твоє серце розбилось так само, як автобус на Лунік. Ти хотів на пару, а приїхав на рейс до Пиздєць-сіті. Твої гроші зникли швидше, ніж кишені на вокзалі. Ти думаєш, що студент, а живеш як циган з Lunik IX. Твій диплом буде коштувати стільки ж, як пиво на вокзалі. Ти закохався, а вона пішла з циганом із вокзалу. Твоє майбутнє — endless hujovina на Луніку. Ти думав, що освіта — це шанс, а це пиздець як смітник на Lunik IX. Ти вийшов із Kauflandu, а твої покупки вже у цигана. Твоє життя таке ж гучне, як вокзал о 6 ранку. Ти хотів стати айтішником, а став локальним piča на вокзалі. Твої мрії розлетілись, як маршрутки з вокзалу. Ти думав, що Кошице — це Європа, а вийшло Лунік IX. Твоє кохання закінчилось на “kurva, choď preč”. Ти сидів на Boženke, а прокинувся на вокзалі. Твої гроші згоріли так само, як квартира на Луніку. Ти хотів на екзамен, а потрапив на циганське весілля. Твоє життя таке ж повне пиздець, як тролейбус на Lunik IX. Ти написав курсову, а цигани вже здали її за тебе. Твоє серце таке ж пусте, як перон вокзалу вночі. Ти думав, що виживеш, а цигани вже винесли твій ноут. Твоє майбутнє схоже на Lunik IX — всі тікають. Ти зайшов у чат студентів, а там більше матюків, ніж на вокзалі. Ти написав викладачу, а він сказав: “нехай тебе цигани навчать”. Твої відносини заглохли швидше, ніж автобус на Лунік. Ти хотів борщ, а отримав гівно з вокзального бістро. Твої конспекти зникли так само, як зарплата на Луніку. Ти думаєш, що універ, а це базар на вокзалі. Твоє життя — endless kokotina між вокзалом і Lunik IX. Ти хотів стипендію, а отримав курву і piča. Твоє майбутнє таке ж сіре, як вокзал у дощ. Ти думав, що студентське життя, а воно як Lunik IX — пиздець."""
    BLOCK = "\n".join(s.strip() for s in text.split(". ") if s.strip())
    inserted = add_predictions_from_block(BLOCK, locale="uk")

    main()

    atexit.register(close_db)
